# Data Model: Local Development Environment

**Feature**: 001-create-a-local
**Date**: 2025-10-27

## Overview
This document defines the data structures, configurations, and state management for the local development environment.

## Environment State Model

### Environment Lifecycle States
```
┌─────────┐
│  ABSENT │  Initial state, no .local directory exists
└────┬────┘
     │ start.sh (without --reset)
     ↓
┌─────────────┐
│ INITIALIZED │  .local/ created, volumes allocated
└──────┬──────┘
       │ docker compose up
       ↓
┌────────────┐
│  STARTING  │  Services launching, health checks pending
└─────┬──────┘
      │ all health checks pass
      ↓
┌─────────┐
│ HEALTHY │  All services running and ready
└────┬────┘
     │ stop.sh
     ↓
┌─────────┐
│ STOPPED │  Services stopped, volumes persist
└────┬────┘
     │ start.sh --reset
     ↓
┌─────────┐
│ RESET   │  Volumes wiped, return to ABSENT
└─────────┘
```

### State Persistence
- **ABSENT**: No state persisted
- **INITIALIZED**: Directory structure exists, no data
- **STOPPED**: All data persisted in `.local/` volumes
- **HEALTHY**: Active services + persisted data

## Configuration Model

### Docker Compose Service Definitions

#### Service: Hugr
```yaml
hugr:
  image: ${HUGR_IMAGE:-hugr/hugr:latest}
  ports:
    - "8080:8080"
  environment:
    - DATABASE_URL=postgresql://hugr:hugr@postgres:5432/hugr
    - REDIS_URL=redis://redis:6379
    - S3_ENDPOINT=http://minio:9000
    - KEYCLOAK_URL=http://keycloak:8080
    - KEYCLOAK_REALM=hugr
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
    minio:
      condition: service_healthy
    keycloak:
      condition: service_healthy
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
    interval: 10s
    timeout: 5s
    retries: 5
```

#### Service: PostgreSQL
```yaml
postgres:
  image: ${POSTGRES_IMAGE:-postgres:15-alpine}
  environment:
    - POSTGRES_USER=hugr
    - POSTGRES_PASSWORD=hugr
    - POSTGRES_DB=hugr
  volumes:
    - ./local/pg-data:/var/lib/postgresql/data
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U hugr"]
    interval: 5s
    timeout: 5s
    retries: 5
```

#### Service: Redis
```yaml
redis:
  image: ${REDIS_IMAGE:-redis:7-alpine}
  command: redis-server --appendonly yes
  volumes:
    - ./.local/redis-data:/data
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 5s
    timeout: 3s
    retries: 5
```

#### Service: MinIO
```yaml
minio:
  image: ${MINIO_IMAGE:-minio/minio:latest}
  command: server /data --console-address ":9001"
  environment:
    - MINIO_ROOT_USER=minioadmin
    - MINIO_ROOT_PASSWORD=minioadmin
  ports:
    - "9000:9000"
    - "9001:9001"
  volumes:
    - ./.local/minio:/data
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
    interval: 10s
    timeout: 5s
    retries: 5
```

#### Service: Keycloak
```yaml
keycloak:
  image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:latest}
  command: start-dev --import-realm
  environment:
    - KEYCLOAK_ADMIN=admin
    - KEYCLOAK_ADMIN_PASSWORD=admin
    - KC_HTTP_PORT=8080
  ports:
    - "8180:8080"
  volumes:
    - ./keycloak/realm-config.json:/opt/keycloak/data/import/realm.json
    - ./.local/keycloak:/opt/keycloak/data/h2
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
    interval: 10s
    timeout: 5s
    retries: 10
```

### Environment Variables (.env file)
```bash
# Service Images (versions from hugr examples)
HUGR_IMAGE=hugr/hugr:latest
POSTGRES_IMAGE=postgres:15-alpine
REDIS_IMAGE=redis:7-alpine
MINIO_IMAGE=minio/minio:latest
KEYCLOAK_IMAGE=quay.io/keycloak/keycloak:latest

# Database Configuration
POSTGRES_USER=hugr
POSTGRES_PASSWORD=hugr
POSTGRES_DB=hugr
DATABASE_URL=postgresql://hugr:hugr@postgres:5432/hugr

# Redis Configuration
REDIS_URL=redis://redis:6379

# MinIO Configuration
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin
S3_ENDPOINT=http://minio:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin

# Keycloak Configuration
KEYCLOAK_URL=http://keycloak:8080
KEYCLOAK_REALM=hugr
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=admin

# Hugr Authentication
SECRET_KEY=your-secret-key-here  # For x-hugr-secret header (data loading scripts)

# Data Paths
SYNTHEA_REPO=/Users/vgribanov/projects/synthea
EXAMPLES_REPO=/Users/vgribanov/projects/hugr-lab/examples

# Data Generation Parameters
SYNTHEA_PATIENT_COUNT=10000
SYNTHEA_STATE=Massachusetts
SYNTHEA_SEED=12345
```

## Data Source Model

### Synthea Data Source
```json
{
  "name": "synthea_patients",
  "type": "duckdb",
  "description": "Synthetic patient data generated by Synthea",
  "config": {
    "path": "/data/synthea.duckdb",
    "tables": [
      "patients",
      "encounters",
      "conditions",
      "medications",
      "observations",
      "procedures",
      "immunizations",
      "allergies",
      "careplans"
    ],
    "schema": "main"
  },
  "metadata": {
    "patient_count": 10000,
    "generated_date": "2025-10-27",
    "state": "Massachusetts",
    "version": "3.2.0"
  }
}
```

**DuckDB Schema** (from Synthea CSV output):
- **patients**: id, birthdate, deathdate, ssn, drivers, passport, prefix, first, last, suffix, maiden, marital, race, ethnicity, gender, birthplace, address, city, state, county, zip, lat, lon, healthcare_expenses, healthcare_coverage
- **encounters**: id, start, stop, patient, organization, provider, payer, encounterclass, code, description, base_cost, total_claim_cost, payer_coverage, reasoncode, reasondescription
- **conditions**: start, stop, patient, encounter, code, description
- **medications**: start, stop, patient, payer, encounter, code, description, base_cost, payer_coverage, dispenses, totalcost, reasoncode, reasondescription
- **observations**: date, patient, encounter, category, code, description, value, units, type
- **procedures**: start, stop, patient, encounter, code, description, base_cost, reasoncode, reasondescription
- **immunizations**: date, patient, encounter, code, description, base_cost
- **allergies**: start, stop, patient, encounter, code, system, description, type, category, reaction1, description1, severity1, reaction2, description2, severity2
- **careplans**: id, start, stop, patient, encounter, code, description, reasoncode, reasondescription

### Open Payments Data Source
```json
{
  "name": "open_payments_2023",
  "type": "parquet",
  "description": "CMS Open Payments general payments data for 2023",
  "config": {
    "path": "/data/open-payments-2023/",
    "format": "parquet",
    "partition_cols": ["year", "month"]
  },
  "metadata": {
    "year": 2023,
    "record_count": "~11.8M",
    "data_source": "CMS Open Payments",
    "download_date": "2025-10-27"
  }
}
```

**Schema** (Open Payments fields):
- **Core Fields**: Record_ID, Program_Year, Payment_Publication_Date
- **Payment Details**: Total_Amount_of_Payment_USDollars, Date_of_Payment, Number_of_Payments_Included_in_Total_Amount, Form_of_Payment_or_Transfer_of_Value, Nature_of_Payment_or_Transfer_of_Value
- **Physician**: Covered_Recipient_Type, Physician_Profile_ID, Physician_First_Name, Physician_Last_Name, Physician_Specialty, Recipient_Primary_Business_Street_Address_Line1, Recipient_City, Recipient_State, Recipient_Zip_Code
- **Manufacturer**: Applicable_Manufacturer_or_Applicable_GPO_Making_Payment_Name, Applicable_Manufacturer_or_Applicable_GPO_Making_Payment_ID, Applicable_Manufacturer_or_Applicable_GPO_Making_Payment_State, Applicable_Manufacturer_or_Applicable_GPO_Making_Payment_Country
- **Product**: Name_of_Associated_Covered_Drug_or_Biological1, NDC_of_Associated_Covered_Drug_or_Biological1, Product_Category_or_Therapeutic_Area_1

## Script Interface Model

### start.sh
```bash
Usage: start.sh [OPTIONS]

Options:
  --reset        Wipe all volumes and start fresh
  -v, --verbose  Enable verbose output
  --no-data      Skip data loading step
  --help         Show this help message

Exit Codes:
  0  - Success (all services healthy)
  1  - Prerequisites missing (docker, docker-compose, etc.)
  2  - Docker compose failed
  3  - Health checks failed
  4  - Data loading failed (if --no-data not set)

Output:
  - Status messages for each step
  - Service health check results
  - Final status summary
  - Connection information (URLs, credentials)
```

### stop.sh
```bash
Usage: stop.sh [OPTIONS]

Options:
  -v, --verbose  Enable verbose output
  --help         Show this help message

Exit Codes:
  0  - Success (all services stopped)
  1  - Docker compose failed

Output:
  - Service shutdown status
  - Data persistence confirmation
```

### load-data.sh
```bash
Usage: load-data.sh [OPTIONS]

Options:
  --synthea-only     Load only Synthea data
  --openpayments-only Load only Open Payments data
  --force            Force reload even if data exists
  -v, --verbose      Enable verbose output
  --help             Show this help message

Exit Codes:
  0  - Success (all data loaded)
  1  - Prerequisites missing
  2  - Hugr not healthy
  3  - Data generation failed
  4  - Data source registration failed
  5  - Data load verification failed

Output:
  - Data generation progress
  - Data source registration status
  - Verification query results
  - Summary statistics
```

### health-check.sh
```bash
Usage: health-check.sh [OPTIONS]

Options:
  -v, --verbose     Enable verbose output
  --wait [TIMEOUT]  Wait for services to become healthy (default 120s)
  --help            Show this help message

Exit Codes:
  0  - All services healthy
  1  - One or more services unhealthy
  2  - Timeout waiting for health

Output:
  - Per-service health status
  - Response times
  - Error details if unhealthy
```

## Keycloak Realm Model

### Realm Configuration
```json
{
  "realm": "hugr",
  "enabled": true,
  "sslRequired": "external",
  "registrationAllowed": false,
  "resetPasswordAllowed": true,
  "roles": {
    "realm": [
      {
        "name": "admin",
        "description": "Full administrative access"
      },
      {
        "name": "viewer",
        "description": "Read-only access"
      },
      {
        "name": "analyst",
        "description": "Data analysis access"
      }
    ]
  },
  "users": [
    {
      "username": "admin@example.com",
      "enabled": true,
      "credentials": [{"type": "password", "value": "admin123"}],
      "realmRoles": ["admin"]
    },
    {
      "username": "viewer@example.com",
      "enabled": true,
      "credentials": [{"type": "password", "value": "viewer123"}],
      "realmRoles": ["viewer"]
    },
    {
      "username": "analyst@example.com",
      "enabled": true,
      "credentials": [{"type": "password", "value": "analyst123"}],
      "realmRoles": ["analyst"]
    }
  ],
  "clients": [
    {
      "clientId": "hugr-graphql",
      "enabled": true,
      "publicClient": false,
      "protocol": "openid-connect",
      "redirectUris": ["http://localhost:8080/*"],
      "webOrigins": ["http://localhost:8080"]
    }
  ]
}
```

## Validation Rules

### Service Health Validation
```bash
# PostgreSQL
psql $DATABASE_URL -c "SELECT 1" > /dev/null 2>&1 || exit 1

# Redis
redis-cli -u $REDIS_URL ping | grep -q PONG || exit 1

# MinIO
mc alias set local $S3_ENDPOINT $S3_ACCESS_KEY $S3_SECRET_KEY || exit 1

# Keycloak
curl -f "$KEYCLOAK_URL/health/ready" || exit 1

# Hugr GraphQL
curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ __schema { queryType { name } } }"}' \
  | jq -e '.data.__schema.queryType.name' || exit 1
```

### Data Load Validation
```bash
# Synthea data source exists
curl -X POST http://localhost:8080/graphql \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "query": "query { dataSources { name } }"
  }' \
  | jq -e '.data.dataSources[] | select(.name=="synthea_patients")' || exit 1

# Patient count verification
curl -X POST http://localhost:8080/graphql \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "query": "query { synthea_patients { patients { count } } }"
  }' \
  | jq -e '.data.synthea_patients.patients.count == 10000' || exit 1
```

## State Transitions

### Normal Startup (ABSENT → HEALTHY)
1. Check prerequisites (Docker, compose, curl, jq)
2. Create `.local/` directory structure
3. Copy/generate configuration files
4. Run `docker compose up -d`
5. Wait for health checks to pass
6. Load data (if not --no-data)
7. Verify data sources
8. Display connection information

### Reset Startup (STOPPED → HEALTHY)
1. Stop all services
2. Remove `.local/` directory
3. Proceed with Normal Startup

### Graceful Shutdown (HEALTHY → STOPPED)
1. Run `docker compose down` (preserves volumes)
2. Verify all containers stopped
3. Display data persistence location

## Error Recovery

### Service Failure
- Individual service unhealthy: Check logs `docker compose logs <service>`
- Restart single service: `docker compose restart <service>`
- Full restart: `stop.sh && start.sh`

### Data Load Failure
- Partial load: Re-run `load-data.sh --force`
- Clean reload: `start.sh --reset` then `load-data.sh`

### Port Conflicts
- Modify `.env` file port mappings
- Run `docker compose down && docker compose up -d`

## Summary

Data model complete with:
- 5 service definitions (Hugr, Postgres, Redis, MinIO, Keycloak)
- 2 data sources (Synthea DuckDB, Open Payments Parquet)
- 4 script interfaces (start, stop, load-data, health-check)
- Environment state machine (5 states)
- Keycloak realm with 3 roles, 3 users, 1 client
- Validation rules for services and data
- Error recovery procedures

**Next**: Create contract definitions and test scaffolds
